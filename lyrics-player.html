<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘éŸ³ä¹æ’­æ”¾å™¨</title>
    <style>
        /* ========== å¯è‡ªå®šä¹‰å˜é‡ ========== */
        :root {
            --text-color: #fff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
            --lyric-color: rgba(255, 255, 255, 0.6);
            --lyric-active-color: #fff;
            --lyric-translation-color: rgba(255, 255, 255, 0.6);
            --control-bg: rgba(255, 255, 255, 0.1);
            --control-hover: rgba(255, 255, 255, 0.2);
            --progress-bg: rgba(255, 255, 255, 0.15);
            --progress-fill: #fff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #000;
            color: var(--text-color);
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* ========== åŠ¨æ€èƒŒæ™¯ ========== */
        .bg-layer {
            position: fixed;
            top: -10%;
            left: -10%;
            width: 120%;
            height: 120%;
            background-size: cover;
            background-position: center;
            filter: blur(80px) brightness(0.6);
            z-index: -2;
            opacity: 0;
            transition: opacity 1.5s ease;
        }

        .bg-layer.active {
            opacity: 1;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            /* è½»å¾®æš—åŒ– */
            z-index: -1;
            backdrop-filter: blur(60px);
            /* é¢å¤–çš„æ¨¡ç³Šå±‚ï¼Œå¢åŠ å¹³æ»‘åº¦ */
        }

        /* ä¸»å®¹å™¨ - å·¦å³åˆ†æ  */
        .container {
            display: flex;
            height: 100vh;
            padding: 60px 40px;
            gap: 80px;
            /* å‡å°é—´è· */
            max-width: 1600px;
            /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢è¶…å®½å±å¤ªæ•£ */
            margin: 0 auto;
            position: relative;
            z-index: 1;
            justify-content: center;
            /* æ•´ä½“å±…ä¸­ */
        }

        /* ========== å·¦ä¾§æ’­æ”¾å™¨åŒºåŸŸ ========== */
        /* ========== å·¦ä¾§æ’­æ”¾å™¨åŒºåŸŸ ========== */
        .player-section {
            flex: 0 0 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding-top: 80px;
            /* æ•´ä½“ä¸‹ç§» */
        }



        /* å°é¢å®¹å™¨ */
        .cover-wrapper {
            position: relative;
            margin-bottom: 48px;
            border-radius: 16px;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.5), 0 20px 40px rgba(0, 0, 0, 0.3);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .cover-wrapper:hover {
            transform: scale(1.02);
        }

        .cover {
            width: 460px;
            height: 460px;
            display: block;
            object-fit: cover;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
        }

        /* æ­Œæ›²ä¿¡æ¯ */
        .song-info {
            text-align: center;
            width: 100%;
            margin-bottom: 40px;
        }

        .title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .artist {
            font-size: 20px;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* è¿›åº¦æ¡ */
        .progress-section {
            width: 100%;
            margin-bottom: 40px;
            padding: 0 10px;
        }

        /* ... (progress bar styles unchanged) ... */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--progress-bg);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            transition: height 0.2s ease;
        }

        .progress-bar:hover {
            height: 8px;
            border-radius: 4px;
        }

        .progress-fill {
            height: 100%;
            background: var(--progress-fill);
            border-radius: inherit;
            width: 0%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 12px;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }

        .control-btn {
            width: 56px;
            height: 56px;
            border: none;
            border-radius: 50%;
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.play-btn {
            width: 80px;
            height: 80px;
            font-size: 36px;
            background: #fff;
            color: #000;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .control-btn.play-btn:hover {
            transform: scale(1.05);
            background: #fff;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }

        /* éŸ³é‡æ§åˆ¶ */
        .volume-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 40px;
            opacity: 0;
            transition: opacity 0.3s;
            height: 24px;
            /* å›ºå®šé«˜åº¦ç¡®ä¿å¯¹é½ */
        }

        .player-section:hover .volume-section {
            opacity: 1;
        }

        .volume-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            height: 24px;
            width: 24px;
        }

        .volume-slider {
            width: 120px;
            height: 4px;
            appearance: none;
            -webkit-appearance: none;
            background: var(--progress-bg);
            border-radius: 2px;
            outline: none;
            margin: 0;
            /* ç§»é™¤é»˜è®¤è¾¹è· */
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            margin-top: -4px;
            /* å‚ç›´å±…ä¸­ä¿®æ­£ (å¦‚æœéœ€è¦) */
        }

        /* é’ˆå¯¹ Firefox çš„ä¿®æ­£ */
        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* æ­Œè¯åç§»æ§åˆ¶ */
        .lyric-offset-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .player-section:hover .lyric-offset-section {
            opacity: 1;
        }

        .offset-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-right: 4px;
        }

        .offset-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .offset-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .offset-btn:active {
            transform: scale(0.95);
        }

        .offset-value {
            font-size: 12px;
            font-weight: 500;
            min-width: 45px;
            text-align: center;
            color: var(--text-color);
            font-variant-numeric: tabular-nums;
        }

        .offset-reset {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .offset-reset:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        /* ========== å³ä¾§æ­Œè¯åŒºåŸŸ ========== */
        .lyrics-section {
            flex: 0 1 800px;
            /* é™åˆ¶å®½åº¦ï¼Œä¸å†æ— é™ä¼¸å±• */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            /* å±…ä¸­å¯¹é½æ­Œè¯å®¹å™¨ */
            overflow: hidden;
            position: relative;
            padding-left: 60px;
            /* æ­Œè¯æ•´ä½“å³ç§» */
        }

        .lyrics-container {
            height: 80vh;
            width: 100%;
            max-width: 900px;
            overflow: hidden;
            position: relative;
            padding-right: 60px;
            /* é˜²æ­¢æ”¾å¤§åçš„æ­Œè¯è¢«è£åˆ‡ */
            box-sizing: border-box;
            mask-image: linear-gradient(transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(transparent 0%, black 15%, black 85%, transparent 100%);
        }

        .lyrics-scroll {
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding-top: 35vh;
            will-change: transform;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            /* æ­Œè¯æ–‡æœ¬å·¦å¯¹é½ */
        }

        .lyric-line {
            padding: 16px 0;
            font-size: 32px;
            color: var(--lyric-color);
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            line-height: 1.4;
            cursor: pointer;
            transform-origin: left center;
            filter: blur(0.5px);
            opacity: 0.5;
            width: 100%;
        }

        .lyric-line:hover {
            opacity: 0.8;
            filter: blur(0px);
        }

        .lyric-line.active {
            color: var(--lyric-active-color);
            font-size: 32px;
            /* ä¿æŒç›¸åŒå­—å· */
            font-weight: 700;
            filter: blur(0px);
            opacity: 1;
            transform: none;
            /* ä¸ç¼©æ”¾ï¼Œé¿å…æ¢è¡Œ */
            text-shadow: 0 4px 30px rgba(255, 255, 255, 0.3), 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .lyric-translation {
            font-size: 28px;
            /* å¢å¤§ç¿»è¯‘å­—ä½“ */
            color: var(--lyric-translation-color);
            margin-top: 10px;
            font-weight: 500;
            opacity: 0.8;
        }

        .lyric-line.active .lyric-translation {
            color: rgba(255, 255, 255, 0.8);
        }

        /* è®¾ç½®æŒ‰é’® */
        .settings-btn {
            position: fixed;
            top: 30px;
            right: 30px;
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 20px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        /* å®‰å…¨æç¤º & é…ç½®æ ·å¼ (ä¿æŒåŸæœ‰ï¼Œå¾®è°ƒé¢œè‰²) */
        .security-notice {
            background: rgba(255, 193, 7, 0.15);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #fff;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
                padding: 30px;
                gap: 40px;
                height: auto;
                min-height: 100vh;
            }

            .player-section {
                flex: none;
                width: 100%;
            }

            .cover {
                width: 280px;
                height: 280px;
            }

            .lyrics-section {
                padding-left: 0;
                height: 60vh;
            }

            .lyric-line.active {
                font-size: 28px;
            }
        }

        /* å…¨å±æŒ‰é’® */
        .fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: var(--control-bg);
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
            /* ç¡®ä¿åœ¨é¡¶éƒ¨å·¥å…·æ ä¹‹ä¸Š */
        }

        .fullscreen-btn:hover {
            background: var(--control-hover);
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3), transparent);
            pointer-events: none;
        }

        /* ç”¨ JS æ§åˆ¶çš„æ˜¾ç¤ºçŠ¶æ€ */
        body.show-controls .top-bar,
        body.show-controls .fullscreen-btn,
        body.show-controls .settings-btn {
            opacity: 1;
            pointer-events: auto;
        }

        .player-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        .player-selector:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .player-selector-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .player-selector-name {
            font-size: 14px;
            font-weight: 500;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-selector-arrow {
            font-size: 10px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        /* æ’­æ”¾å™¨åˆ‡æ¢å¼¹å±‚ */
        .player-switcher-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 80px;
            z-index: 200;
            backdrop-filter: blur(5px);
        }

        .player-switcher-overlay.show {
            display: flex;
        }

        .player-switcher {
            background: rgba(30, 30, 50, 0.95);
            border-radius: 16px;
            padding: 24px;
            min-width: 320px;
            max-width: 400px;
            max-height: 60vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
        }

        .player-switcher h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .player-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .player-item.active {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .player-item-icon {
            font-size: 20px;
            margin-right: 12px;
        }

        .player-item-info {
            flex: 1;
            overflow: hidden;
        }

        .player-item-name {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-item-id {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-item-check {
            margin-left: 8px;
            color: #4ade80;
            font-size: 16px;
        }

        .loading-text {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }

        /* é”™è¯¯/åŠ è½½çŠ¶æ€ */
        .status-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 20px;
        }

        .status-message .icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        /* å“åº”å¼ */
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
                padding: 80px 20px 20px 20px;
                /* å¢åŠ é¡¶éƒ¨ padding ç»™å·¥å…·æ ç•™ç©ºé—´ */
                gap: 20px;
                max-width: 100%;
                height: auto;
                min-height: 100vh;
            }

            .player-section {
                flex: 0 0 auto;
                padding-top: 0;
            }

            .cover-wrapper {
                margin-bottom: 24px;
            }

            .cover {
                width: 200px;
                height: 200px;
            }

            .song-info {
                margin-bottom: 20px;
            }

            .title {
                font-size: 24px;
            }

            .artist {
                font-size: 16px;
            }

            /* æ­Œè¯åŒºåŸŸç§»åŠ¨ç«¯æ ·å¼ */
            .lyrics-section {
                flex: 1;
                min-height: 300px;
                padding-left: 20px;
                padding-right: 20px;
            }

            .lyrics-container {
                height: 300px;
                max-width: 100%;
            }

            .lyric-line {
                font-size: 20px;
                padding: 10px 0;
            }

            .lyric-translation {
                font-size: 16px;
            }

            /* ç§»åŠ¨ç«¯è§†å›¾åˆ‡æ¢ - é»˜è®¤æ˜¾ç¤ºæ’­æ”¾å™¨ */
            body.mobile-lyrics-view .player-section {
                display: none;
            }

            body.mobile-lyrics-view .lyrics-section {
                flex: 1;
                min-height: calc(100vh - 120px);
            }

            body.mobile-lyrics-view .lyrics-container {
                height: calc(100vh - 160px);
            }

            /* é»˜è®¤éšè—æ­Œè¯åŒºåŸŸ */
            body:not(.mobile-lyrics-view) .lyrics-section {
                display: none;
            }

            /* æŒ‰é’®ä½ç½®è°ƒæ•´ï¼Œé¿å…é‡å  */
            .settings-btn {
                top: 15px;
                right: 110px;
                /* ç§»åˆ°æœ€å·¦è¾¹ */
                width: 36px;
                height: 36px;
            }

            .fullscreen-btn {
                top: 15px;
                right: 60px;
                /* ä¸­é—´ä½ç½® */
                width: 36px;
                height: 36px;
            }

            /* æ·»åŠ æ­Œè¯åˆ‡æ¢æŒ‰é’®æ ·å¼ */
            .lyrics-toggle-btn {
                display: block !important;
                position: fixed;
                top: 15px;
                right: 15px;
                width: 36px;
                height: 36px;
                border: none;
                border-radius: 8px;
                background: var(--control-bg);
                color: white;
                font-size: 16px;
                cursor: pointer;
                z-index: 100;
            }

            /* é¡¶éƒ¨å·¥å…·æ ç§»åŠ¨ç«¯æ ·å¼ */
            .top-bar {
                height: 50px;
                padding: 0 10px;
            }

            .player-selector {
                padding: 8px 16px;
                font-size: 14px;
            }

            /* æ­Œè¯åç§»æ§åˆ¶ç§»åŠ¨ç«¯ - åªåœ¨æ’­æ”¾å™¨è§†å›¾æ˜¾ç¤º */
            body.mobile-lyrics-view .lyric-offset-section,
            body.mobile-lyrics-view .volume-section {
                display: none;
            }

            .lyric-offset-section {
                flex-wrap: wrap;
                gap: 6px;
            }

            .offset-btn {
                padding: 6px 12px;
            }

            /* éŸ³é‡å’Œåç§»æ§åˆ¶è§¦æ‘¸è®¾å¤‡å§‹ç»ˆå¯è§ */
            .volume-section,
            .lyric-offset-section {
                opacity: 1;
            }
        }

        /* æ­Œè¯åˆ‡æ¢æŒ‰é’® - æ¡Œé¢ç«¯éšè— */
        .lyrics-toggle-btn {
            display: none;
        }

        /* ========== é…ç½®å¯¹è¯æ¡†æ ·å¼ ========== */
        .config-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .config-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .config-dialog {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .config-dialog h2 {
            margin-bottom: 8px;
            font-size: 24px;
        }

        .config-desc {
            color: var(--text-secondary);
            margin-bottom: 24px;
            font-size: 14px;
        }

        .config-form label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .config-form input[type="text"],
        .config-form input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            margin-bottom: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        .config-form input:focus {
            border-color: var(--bg-gradient-start);
        }

        .config-form input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .help-link {
            color: var(--bg-gradient-start);
            text-decoration: none;
            font-size: 12px;
            margin-left: 8px;
        }

        .help-link:hover {
            text-decoration: underline;
        }

        .token-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: -10px;
            margin-bottom: 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .token-toggle input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }

        /* é…ç½®å¤´éƒ¨å’Œå…³é—­æŒ‰é’® */
        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .config-header h2 {
            margin: 0;
        }

        .config-close-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .config-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .config-close-btn.hidden {
            display: none;
        }

        .config-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .config-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .config-btn.primary {
            background: var(--bg-gradient-start);
            color: #fff;
        }

        .config-btn.primary:hover {
            background: #25d366;
        }

        .config-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .config-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .token-help {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .token-help h3 {
            font-size: 16px;
            margin-bottom: 12px;
        }

        .token-help ol {
            padding-left: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .token-help li strong {
            color: #fff;
        }

        .token-help .config-btn {
            margin-top: 16px;
            width: 100%;
        }

        /* è®¾ç½®æŒ‰é’® */
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 70px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            background: var(--control-bg);
            color: white;
            font-size: 18px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .settings-btn:hover {
            background: var(--control-hover);
        }

        /* å®‰å…¨æç¤º */
        .security-notice {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .security-notice strong {
            display: block;
            margin-bottom: 8px;
            color: #ffc107;
        }

        .security-notice ul {
            margin: 0;
            padding-left: 20px;
            color: var(--text-secondary);
        }

        .security-notice li {
            margin-bottom: 4px;
        }

        /* ä¸‹æ‹‰é€‰æ‹©æ¡† */
        .config-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            margin-bottom: 8px;
            outline: none;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23fff' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
        }

        .config-select:focus {
            border-color: var(--bg-gradient-start);
        }

        .config-select option {
            background: #1a1a2e;
            color: #fff;
        }

        .entity-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .config-loading {
            text-align: center;
            padding: 40px 0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--bg-gradient-start);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .config-loading p {
            color: var(--text-secondary);
        }
    </style>
</head>

<body>
    <!-- åŠ¨æ€èƒŒæ™¯å±‚ -->
    <div class="bg-layer" id="bgLayer1"></div>
    <div class="bg-layer" id="bgLayer2"></div>
    <div class="bg-overlay"></div>

    <!-- ä¸»å†…å®¹ -->
    <div class="container" id="mainContainer" style="display: none;">
        <!-- å·¦ä¾§ï¼šæ’­æ”¾å™¨ -->
        <div class="player-section">
            <div class="cover-wrapper">
                <img class="cover" id="cover" src="" alt="å°é¢">
            </div>

            <div class="song-info">
                <div class="title" id="title">åŠ è½½ä¸­...</div>
                <div class="artist" id="artist"></div>
            </div>

            <div class="progress-section">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn" onclick="control('previous')" title="ä¸Šä¸€é¦–">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" />
                    </svg>
                </button>
                <button class="control-btn play-btn" id="playBtn" onclick="control('play_pause')" title="æ’­æ”¾/æš‚åœ">
                    <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                </button>
                <button class="control-btn" onclick="control('next')" title="ä¸‹ä¸€é¦–">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                    </svg>
                </button>
            </div>

            <div class="volume-section">
                <span class="volume-icon" id="volumeIcon" onclick="toggleMute()">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path
                            d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                    </svg>
                </span>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50"
                    onchange="setVolume(this.value)" oninput="setVolume(this.value)">
            </div>

            <!-- æ­Œè¯åç§»è°ƒæ•´ -->
            <div class="lyric-offset-section">
                <span class="offset-label">æ­Œè¯åç§»</span>
                <button class="offset-btn" onclick="adjustLyricOffset(-1000)">-1s</button>
                <button class="offset-btn" onclick="adjustLyricOffset(-100)">-0.1s</button>
                <span class="offset-value" id="offsetValue">0s</span>
                <button class="offset-btn" onclick="adjustLyricOffset(100)">+0.1s</button>
                <button class="offset-btn" onclick="adjustLyricOffset(1000)">+1s</button>
                <button class="offset-reset" onclick="resetLyricOffset()" title="é‡ç½®">â†º</button>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ­Œè¯ -->
        <div class="lyrics-section">
            <div class="lyrics-container">
                <div class="lyrics-scroll" id="lyricsScroll"></div>
            </div>
        </div>
    </div>

    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="top-bar" id="topBar">
        <div class="player-selector" id="playerSelector" onclick="showPlayerSwitcher()">
            <span class="player-selector-label">å½“å‰æ’­æ”¾å™¨ï¼š</span>
            <span class="player-selector-name" id="currentPlayerName">åŠ è½½ä¸­...</span>
            <span class="player-selector-arrow">â–¼</span>
        </div>
    </div>

    <!-- æ’­æ”¾å™¨åˆ‡æ¢åˆ—è¡¨ -->
    <div class="player-switcher-overlay" id="playerSwitcherOverlay" onclick="hidePlayerSwitcher()">
        <div class="player-switcher" onclick="event.stopPropagation()">
            <h3>é€‰æ‹©æ’­æ”¾å™¨</h3>
            <div class="player-list" id="playerList">
                <div class="loading-text">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- çŠ¶æ€æ¶ˆæ¯ -->
    <div class="status-message" id="statusMessage">
        <div class="icon">ğŸµ</div>
        <div id="statusText">æ­£åœ¨è¿æ¥...</div>
    </div>

    <!-- é…ç½®å¯¹è¯æ¡† -->
    <div class="config-overlay" id="configOverlay">
        <div class="config-dialog">
            <div class="config-header">
                <h2>ğŸµ æ’­æ”¾å™¨é…ç½®</h2>
                <button class="config-close-btn" id="configCloseBtn" onclick="hideConfig()" title="å…³é—­">âœ•</button>
            </div>

            <!-- æ­¥éª¤ 1ï¼šè¾“å…¥ Token -->
            <div id="configStep1">
                <p class="config-desc">ç¬¬ 1 æ­¥ï¼šè¾“å…¥ Home Assistant è®¿é—®ä»¤ç‰Œ</p>

                <div class="config-form">
                    <label for="configHaUrl">Home Assistant åœ°å€</label>
                    <input type="text" id="configHaUrl" placeholder="ç•™ç©ºä½¿ç”¨å½“å‰åŸŸå">

                    <label for="configToken">
                        é•¿æœŸè®¿é—®ä»¤ç‰Œ (Token)
                        <a href="#" onclick="showTokenHelp(); return false;" class="help-link">å¦‚ä½•è·å–?</a>
                    </label>
                    <input type="password" id="configToken" placeholder="ç²˜è´´æ‚¨çš„ Token">
                    <div class="token-toggle">
                        <input type="checkbox" id="showToken" onchange="toggleTokenVisibility()">
                        <label for="showToken">æ˜¾ç¤º Token</label>
                    </div>

                    <div class="security-notice">
                        <strong>ğŸ”’ å®‰å…¨æç¤º</strong>
                        <ul>
                            <li>Token ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­</li>
                            <li>å»ºè®®åœ¨ç§æœ‰ç½‘ç»œä¸­ä½¿ç”¨</li>
                            <li>å¯åˆ›å»ºé™æƒä¸“ç”¨ç”¨æˆ·ä»¥é™ä½é£é™©</li>
                        </ul>
                    </div>

                    <div class="config-actions">
                        <button class="config-btn secondary" onclick="clearConfig()">æ¸…é™¤é…ç½®</button>
                        <button class="config-btn primary" id="verifyTokenBtn" onclick="verifyToken()">éªŒè¯ Token</button>
                    </div>
                </div>

                <div class="token-help" id="tokenHelp" style="display:none;">
                    <h3>ğŸ“ å¦‚ä½•è·å–é•¿æœŸè®¿é—®ä»¤ç‰Œ</h3>
                    <ol>
                        <li>æ‰“å¼€ Home Assistant ç•Œé¢</li>
                        <li>ç‚¹å‡»å·¦ä¸‹è§’æ‚¨çš„<strong>ç”¨æˆ·å¤´åƒ</strong></li>
                        <li>æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨ï¼Œæ‰¾åˆ°<strong>ã€Œé•¿æœŸè®¿é—®ä»¤ç‰Œã€</strong></li>
                        <li>ç‚¹å‡»<strong>ã€Œåˆ›å»ºä»¤ç‰Œã€</strong></li>
                        <li>è¾“å…¥åç§°ï¼ˆå¦‚ã€Œæ­Œè¯æ’­æ”¾å™¨ã€ï¼‰åç‚¹å‡»ç¡®å®š</li>
                        <li>å¤åˆ¶ç”Ÿæˆçš„ä»¤ç‰Œï¼Œç²˜è´´åˆ°ä¸Šæ–¹è¾“å…¥æ¡†</li>
                    </ol>
                    <button class="config-btn secondary" onclick="hideTokenHelp()">æˆ‘çŸ¥é“äº†</button>
                </div>
            </div>

            <!-- æ­¥éª¤ 2ï¼šé€‰æ‹©å®ä½“ -->
            <div id="configStep2" style="display:none;">
                <p class="config-desc">ç¬¬ 2 æ­¥ï¼šé€‰æ‹©åª’ä½“æ’­æ”¾å™¨</p>

                <div class="config-form">
                    <label for="configEntity">é€‰æ‹©æ’­æ”¾å™¨</label>
                    <select id="configEntity" class="config-select">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                    </select>
                    <p class="entity-hint" id="entityHint"></p>

                    <div class="config-actions">
                        <button class="config-btn secondary" onclick="goToStep1()">è¿”å›ä¸Šä¸€æ­¥</button>
                        <button class="config-btn primary" onclick="saveConfig()">ä¿å­˜å¹¶è¿æ¥</button>
                    </div>
                </div>
            </div>

            <!-- éªŒè¯ä¸­çŠ¶æ€ -->
            <div id="configLoading" style="display:none;">
                <div class="config-loading">
                    <div class="spinner"></div>
                    <p id="loadingText">æ­£åœ¨éªŒè¯...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æŒ‰é’® -->
    <button class="settings-btn" onclick="showConfig()" title="è®¾ç½®">âš™ï¸</button>

    <!-- å…¨å±æŒ‰é’® -->
    <button class="fullscreen-btn" onclick="toggleFullscreen()" title="å…¨å±">â›¶</button>

    <!-- æ­Œè¯åˆ‡æ¢æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
    <button class="lyrics-toggle-btn" id="lyricsToggleBtn" onclick="toggleMobileView()" title="åˆ‡æ¢æ­Œè¯">ğŸµ</button>

    <script>
        // ========== é…ç½®ç®¡ç† ==========
        const STORAGE_KEY = 'lyrics_player_config';

        function getConfig() {
            // ä¼˜å…ˆä» URL å‚æ•°è·å–
            const params = new URLSearchParams(window.location.search);
            const urlConfig = {
                entity: params.get('entity'),
                token: params.get('token'),
                ha_url: params.get('ha_url')
            };

            // å¦‚æœ URL æœ‰å‚æ•°ï¼Œä½¿ç”¨ URL å‚æ•°
            if (urlConfig.entity && urlConfig.token) {
                return {
                    entity: urlConfig.entity,
                    token: urlConfig.token,
                    ha_url: urlConfig.ha_url || window.location.origin
                };
            }

            // å¦åˆ™ä» localStorage è·å–
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('è¯»å–é…ç½®å¤±è´¥:', e);
            }

            return null;
        }

        function saveConfigToStorage(config) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
                return true;
            } catch (e) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', e);
                return false;
            }
        }

        function clearConfigFromStorage() {
            try {
                localStorage.removeItem(STORAGE_KEY);
            } catch (e) {
                console.error('æ¸…é™¤é…ç½®å¤±è´¥:', e);
            }
        }

        // ========== é…ç½®å¯¹è¯æ¡† ==========
        function showConfig(forceShowClose = false) {
            const config = getConfig();
            const closeBtn = document.getElementById('configCloseBtn');

            // å¦‚æœå·²æœ‰æœ‰æ•ˆé…ç½®ï¼Œå…è®¸å…³é—­å¯¹è¯æ¡†
            if (config && config.entity && config.token || forceShowClose) {
                closeBtn.classList.remove('hidden');
            } else {
                closeBtn.classList.add('hidden');
            }

            if (config) {
                document.getElementById('configToken').value = config.token || '';
                document.getElementById('configHaUrl').value = config.ha_url || '';
            }
            // æ˜¾ç¤ºæ­¥éª¤1
            document.getElementById('configStep1').style.display = 'block';
            document.getElementById('configStep2').style.display = 'none';
            document.getElementById('configLoading').style.display = 'none';
            document.getElementById('configOverlay').classList.add('show');
        }

        function hideConfig() {
            const config = getConfig();
            // åªæœ‰åœ¨æœ‰æœ‰æ•ˆé…ç½®æ—¶æ‰å…è®¸å…³é—­
            if (config && config.entity && config.token) {
                document.getElementById('configOverlay').classList.remove('show');
            }
        }

        function goToStep1() {
            document.getElementById('configStep1').style.display = 'block';
            document.getElementById('configStep2').style.display = 'none';
            document.getElementById('configLoading').style.display = 'none';
        }

        function showLoading(text) {
            document.getElementById('configStep1').style.display = 'none';
            document.getElementById('configStep2').style.display = 'none';
            document.getElementById('configLoading').style.display = 'block';
            document.getElementById('loadingText').textContent = text;
        }

        async function verifyToken() {
            const token = document.getElementById('configToken').value.trim();
            const ha_url = document.getElementById('configHaUrl').value.trim() || window.location.origin;

            if (!token) {
                alert('è¯·è¾“å…¥é•¿æœŸè®¿é—®ä»¤ç‰Œ');
                return;
            }

            showLoading('æ­£åœ¨éªŒè¯ Token...');

            try {
                // æµ‹è¯• Token æ˜¯å¦æœ‰æ•ˆ
                const testRes = await fetch(`${ha_url}/api/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!testRes.ok) {
                    throw new Error(testRes.status === 401 ? 'Token æ— æ•ˆæˆ–å·²è¿‡æœŸ' : `è¿æ¥å¤±è´¥: ${testRes.status}`);
                }

                showLoading('æ­£åœ¨è·å–æ’­æ”¾å™¨åˆ—è¡¨...');

                // è·å–æ‰€æœ‰ media_player å®ä½“
                const statesRes = await fetch(`${ha_url}/api/states`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!statesRes.ok) {
                    throw new Error('è·å–å®ä½“åˆ—è¡¨å¤±è´¥');
                }

                const states = await statesRes.json();
                const mediaPlayers = states.filter(s => s.entity_id.startsWith('media_player.'));

                if (mediaPlayers.length === 0) {
                    alert('æœªæ‰¾åˆ°ä»»ä½•åª’ä½“æ’­æ”¾å™¨å®ä½“');
                    goToStep1();
                    return;
                }

                // å¡«å……ä¸‹æ‹‰åˆ—è¡¨
                const select = document.getElementById('configEntity');
                select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';

                mediaPlayers.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.entity_id;
                    const friendlyName = player.attributes.friendly_name || player.entity_id;
                    option.textContent = `${friendlyName} (${player.entity_id})`;
                    select.appendChild(option);
                });

                // å¦‚æœä¹‹å‰æœ‰ä¿å­˜çš„å®ä½“ï¼Œè‡ªåŠ¨é€‰ä¸­
                const savedConfig = getConfig();
                if (savedConfig?.entity) {
                    select.value = savedConfig.entity;
                }

                document.getElementById('entityHint').textContent = `å…±æ‰¾åˆ° ${mediaPlayers.length} ä¸ªæ’­æ”¾å™¨`;

                // ä¸´æ—¶ä¿å­˜ Token å’Œ URL
                window._tempToken = token;
                window._tempHaUrl = ha_url;

                // æ˜¾ç¤ºæ­¥éª¤2
                document.getElementById('configStep1').style.display = 'none';
                document.getElementById('configStep2').style.display = 'block';
                document.getElementById('configLoading').style.display = 'none';

            } catch (e) {
                alert('éªŒè¯å¤±è´¥: ' + e.message);
                goToStep1();
            }
        }

        function saveConfig() {
            const entity = document.getElementById('configEntity').value;
            const token = window._tempToken || document.getElementById('configToken').value.trim();
            const ha_url = window._tempHaUrl || document.getElementById('configHaUrl').value.trim() || window.location.origin;

            if (!entity) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæ’­æ”¾å™¨');
                return;
            }

            const config = { entity, token, ha_url };
            if (saveConfigToStorage(config)) {
                hideConfig();
                window.location.reload();
            } else {
                alert('ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function clearConfig() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰é…ç½®å—ï¼Ÿ')) {
                clearConfigFromStorage();
                document.getElementById('configToken').value = '';
                document.getElementById('configHaUrl').value = '';
                window._tempToken = null;
                window._tempHaUrl = null;
            }
        }

        function showTokenHelp() {
            document.getElementById('tokenHelp').style.display = 'block';
        }

        function hideTokenHelp() {
            document.getElementById('tokenHelp').style.display = 'none';
        }

        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('configToken');
            const checkbox = document.getElementById('showToken');
            tokenInput.type = checkbox.checked ? 'text' : 'password';
        }

        // ========== æ’­æ”¾å™¨åˆ‡æ¢åŠŸèƒ½ ==========
        let cachedMediaPlayers = [];

        function showPlayerSwitcher() {
            document.getElementById('playerSwitcherOverlay').classList.add('show');
            loadPlayerList();
        }

        function hidePlayerSwitcher() {
            document.getElementById('playerSwitcherOverlay').classList.remove('show');
        }

        async function loadPlayerList() {
            const listEl = document.getElementById('playerList');
            listEl.innerHTML = '<div class="loading-text">åŠ è½½ä¸­...</div>';

            try {
                const res = await fetch(`${HA_URL}/api/states`, getFetchOptions());
                if (!res.ok) throw new Error('è·å–å¤±è´¥');

                const states = await res.json();
                cachedMediaPlayers = states.filter(s => s.entity_id.startsWith('media_player.'));

                if (cachedMediaPlayers.length === 0) {
                    listEl.innerHTML = '<div class="loading-text">æœªæ‰¾åˆ°æ’­æ”¾å™¨</div>';
                    return;
                }

                listEl.innerHTML = cachedMediaPlayers.map(player => {
                    const friendlyName = player.attributes.friendly_name || player.entity_id;
                    const isActive = player.entity_id === ENTITY_ID;
                    const stateText = player.state === 'playing' ? 'æ­£åœ¨æ’­æ”¾' :
                        player.state === 'paused' ? 'å·²æš‚åœ' :
                            player.state === 'idle' ? 'ç©ºé—²' : player.state;

                    return `
                        <div class="player-item ${isActive ? 'active' : ''}" onclick="switchPlayer('${player.entity_id}')">
                            <span class="player-item-icon">ğŸµ</span>
                            <div class="player-item-info">
                                <div class="player-item-name">${friendlyName}</div>
                                <div class="player-item-id">${player.entity_id} Â· ${stateText}</div>
                            </div>
                            ${isActive ? '<span class="player-item-check">âœ“</span>' : ''}
                        </div>
                    `;
                }).join('');

            } catch (e) {
                listEl.innerHTML = '<div class="loading-text">åŠ è½½å¤±è´¥</div>';
            }
        }

        function switchPlayer(entityId) {
            const config = getConfig();
            if (config) {
                config.entity = entityId;
                saveConfigToStorage(config);
                hidePlayerSwitcher();
                window.location.reload();
            }
        }

        function updateCurrentPlayerName() {
            const config = getConfig();
            if (config && config.entity) {
                // å°è¯•ä»ç¼“å­˜ä¸­è·å–å‹å¥½åç§°
                const player = cachedMediaPlayers.find(p => p.entity_id === config.entity);
                const name = player?.attributes?.friendly_name || config.entity.replace('media_player.', '');
                document.getElementById('currentPlayerName').textContent = name;
            }
        }

        // ========== è·å–å½“å‰é…ç½® ==========
        const config = getConfig();
        let ENTITY_ID = config?.entity || '';
        let TOKEN = config?.token || '';
        let HA_URL = config?.ha_url || window.location.origin;

        // ========== çŠ¶æ€å˜é‡ ==========
        let lyrics = [];
        let tlyrics = [];
        let mergedLyrics = [];
        let currentIndex = -1;
        let currentSongId = '';
        let isPlaying = false;
        let duration = 0;
        let currentPosition = 0;
        let positionUpdatedAt = null;
        let refreshInterval = null;

        // ========== æ­Œè¯åç§» ==========
        const OFFSET_STORAGE_KEY = 'lyrics_player_offset';
        let lyricOffset = parseInt(localStorage.getItem(OFFSET_STORAGE_KEY)) || 0;

        function updateOffsetDisplay() {
            const offsetSec = lyricOffset / 1000;
            const sign = offsetSec >= 0 ? '+' : '';
            document.getElementById('offsetValue').textContent = `${sign}${offsetSec.toFixed(1)}s`;
        }

        function adjustLyricOffset(delta) {
            lyricOffset = Math.max(-10000, Math.min(10000, lyricOffset + delta));
            localStorage.setItem(OFFSET_STORAGE_KEY, lyricOffset);
            updateOffsetDisplay();
        }

        function resetLyricOffset() {
            lyricOffset = 0;
            localStorage.setItem(OFFSET_STORAGE_KEY, lyricOffset);
            updateOffsetDisplay();
        }

        // åˆå§‹åŒ–æ˜¾ç¤º
        document.addEventListener('DOMContentLoaded', updateOffsetDisplay);

        // ========== è®¤è¯å¤´ ==========
        function getHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (TOKEN) {
                headers['Authorization'] = `Bearer ${TOKEN}`;
            }
            return headers;
        }

        function getFetchOptions(method = 'GET', body = null) {
            const options = {
                method,
                headers: getHeaders(),
                credentials: TOKEN ? 'omit' : 'include'
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            return options;
        }

        // ========== LRC è§£æ ==========
        function parseLrc(text) {
            if (!text) return [];
            const lines = [];
            text.split('\n').forEach(line => {
                const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
                if (match) {
                    const time = parseInt(match[1]) * 60 + parseInt(match[2]) + parseInt(match[3]) / (match[3].length === 2 ? 100 : 1000);
                    const text = match[4].trim();
                    if (text) lines.push({ time, text });
                }
            });
            return lines.sort((a, b) => a.time - b.time);
        }

        function mergeLyrics(lrc, tlrc) {
            const tMap = new Map(tlrc.map(t => [t.time.toFixed(2), t.text]));
            return lrc.map(l => ({
                time: l.time,
                text: l.text,
                translation: tMap.get(l.time.toFixed(2)) || ''
            }));
        }

        // ========== è§£æ song_id ==========
        function parseSongId(contentId) {
            try {
                const url = new URL(contentId);
                const data = url.searchParams.get('data');
                if (data) {
                    const decoded = atob(data);
                    return new URLSearchParams(decoded).get('id') || '';
                }
            } catch { }
            return '';
        }

        // ========== API è°ƒç”¨ ==========
        async function fetchState() {
            try {
                const res = await fetch(`${HA_URL}/api/states/${ENTITY_ID}`, getFetchOptions());
                if (!res.ok) {
                    if (res.status === 401) throw new Error('è®¤è¯å¤±è´¥ï¼šToken æ— æ•ˆæˆ–å·²è¿‡æœŸ');
                    if (res.status === 404) throw new Error('å®ä½“ä¸å­˜åœ¨ï¼šè¯·æ£€æŸ¥å®ä½“ ID');
                    throw new Error(`API é”™è¯¯: ${res.status}`);
                }
                return await res.json();
            } catch (e) {
                showStatus('error', e.message);
                return null;
            }
        }

        async function fetchLyrics(songId) {
            try {
                const res = await fetch(`${HA_URL}/cloud_music/api?action=lyric&id=${songId}`, getFetchOptions());
                const data = await res.json();
                lyrics = parseLrc(data.lrc);
                tlyrics = parseLrc(data.tlyric);
                mergedLyrics = mergeLyrics(lyrics, tlyrics);
                renderLyrics();
            } catch (e) {
                console.error('è·å–æ­Œè¯å¤±è´¥:', e);
            }
        }

        // ========== æ§åˆ¶æ’­æ”¾å™¨ ==========
        async function control(action) {
            // æ˜ å°„ action åˆ°æ­£ç¡®çš„ HA æœåŠ¡å
            const actionMap = {
                'previous': 'previous_track',
                'next': 'next_track',
                'play_pause': 'play_pause'
            };
            const service = actionMap[action] || action;
            await fetch(`${HA_URL}/api/services/media_player/media_${service}`,
                getFetchOptions('POST', { entity_id: ENTITY_ID }));
        }

        async function setVolume(value) {
            const volume = parseInt(value) / 100;
            await fetch(`${HA_URL}/api/services/media_player/volume_set`,
                getFetchOptions('POST', { entity_id: ENTITY_ID, volume_level: volume }));
        }

        async function toggleMute() {
            await fetch(`${HA_URL}/api/services/media_player/volume_mute`,
                getFetchOptions('POST', { entity_id: ENTITY_ID, is_volume_muted: true }));
        }

        async function seekTo(position) {
            await fetch(`${HA_URL}/api/services/media_player/media_seek`,
                getFetchOptions('POST', { entity_id: ENTITY_ID, seek_position: position }));
        }

        // ========== æ¸²æŸ“æ­Œè¯ ==========
        function renderLyrics() {
            const container = document.getElementById('lyricsScroll');
            if (mergedLyrics.length === 0) {
                container.innerHTML = '<div class="lyric-line" style="text-align:center;">æš‚æ— æ­Œè¯</div>';
                return;
            }
            container.innerHTML = mergedLyrics.map((l, i) => `
                <div class="lyric-line" data-index="${i}">
                    <div class="lyric-text">${l.text}</div>
                    ${l.translation ? `<div class="lyric-translation">${l.translation}</div>` : ''}
                </div>
            `).join('');
        }

        // åŠ è½½å°é¢å›¾ç‰‡ï¼ˆå¸¦è®¤è¯ + åŠ¨æ€èƒŒæ™¯ï¼‰
        let activeBgLayer = 1;

        async function loadCoverImage(url) {
            const coverEl = document.getElementById('cover');
            const bgLayer1 = document.getElementById('bgLayer1');
            const bgLayer2 = document.getElementById('bgLayer2');

            try {
                // æ„å»ºå®Œæ•´ URL
                const fullUrl = url.startsWith('http') ? url : `${HA_URL}${url}`;

                const res = await fetch(fullUrl, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });

                if (!res.ok) throw new Error('å›¾ç‰‡åŠ è½½å¤±è´¥');

                const blob = await res.blob();
                const blobUrl = URL.createObjectURL(blob);

                // é‡Šæ”¾æ—§çš„ blob URL (ä¿ç•™æœ€è¿‘ä¸€ä¸ªä»¥é˜²é—ªçƒï¼Œå®é™…åº”ç”¨ä¸­å¯ä¼˜åŒ–)
                if (coverEl._blobUrl) {
                    URL.revokeObjectURL(coverEl._blobUrl);
                }
                coverEl._blobUrl = blobUrl;
                coverEl.src = blobUrl;

                // åŠ¨æ€èƒŒæ™¯åˆ‡æ¢ (åŒå±‚äº¤æ›¿æ·¡å…¥æ·¡å‡º)
                const nextLayer = activeBgLayer === 1 ? bgLayer2 : bgLayer1;
                const currentLayer = activeBgLayer === 1 ? bgLayer1 : bgLayer2;

                nextLayer.style.backgroundImage = `url('${blobUrl}')`;
                nextLayer.classList.add('active');
                currentLayer.classList.remove('active');

                activeBgLayer = activeBgLayer === 1 ? 2 : 1;

            } catch (e) {
                console.error('å°é¢åŠ è½½å¤±è´¥:', e);
                // å°è¯•ç›´æ¥åŠ è½½
                const directUrl = url.startsWith('http') ? url : `${HA_URL}${url}`;
                coverEl.src = directUrl;

                // èƒŒæ™¯å›é€€
                const nextLayer = activeBgLayer === 1 ? bgLayer2 : bgLayer1;
                const currentLayer = activeBgLayer === 1 ? bgLayer1 : bgLayer2;

                nextLayer.style.backgroundImage = `url('${directUrl}')`;
                nextLayer.classList.add('active');
                currentLayer.classList.remove('active');

                activeBgLayer = activeBgLayer === 1 ? 2 : 1;
            }
        }

        // ========== æ›´æ–° UI ==========
        async function update(state) {
            const attrs = state.attributes;
            isPlaying = state.state === 'playing';

            document.getElementById('statusMessage').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'flex';

            // åŠ è½½å°é¢å›¾ç‰‡ï¼ˆéœ€è¦è®¤è¯ï¼‰
            const coverUrl = attrs.entity_picture;
            if (coverUrl && coverUrl !== window._lastCoverUrl) {
                window._lastCoverUrl = coverUrl;
                loadCoverImage(coverUrl);
            }

            document.getElementById('title').textContent = attrs.media_title || 'æœªçŸ¥æ­Œæ›²';
            document.getElementById('artist').textContent = attrs.media_artist || '';

            const playIcon = '<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            const pauseIcon = '<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            document.getElementById('playBtn').innerHTML = isPlaying ? pauseIcon : playIcon;

            if (attrs.volume_level !== undefined) {
                document.getElementById('volumeSlider').value = Math.round(attrs.volume_level * 100);
            }

            duration = attrs.media_duration || 0;
            document.getElementById('duration').textContent = formatTime(duration);

            const songId = parseSongId(attrs.media_content_id);
            if (songId && songId !== currentSongId) {
                currentSongId = songId;
                currentIndex = -1;
                lastPosition = 0; // é‡ç½®é˜²æŠ–ä½ç½®
                window._lastSeekTime = 0; // é‡ç½® seek é˜²æŠ–ï¼Œç¡®ä¿æ–°æ­Œä½ç½®åŒæ­¥
                fetchLyrics(songId);
            }

            // åªæœ‰åœ¨æœ€è¿‘æ²¡æœ‰æ‰‹åŠ¨ seek æ—¶æ‰ç”¨ HA çš„ä½ç½®ä¿¡æ¯
            // è¿™é¿å…äº† seek å HA çš„æ—§æ—¶é—´æˆ³è¦†ç›–æˆ‘ä»¬çš„æœ¬åœ°é¢„æµ‹
            const now = Date.now();
            if (!window._lastSeekTime || now - window._lastSeekTime > 2000) {
                currentPosition = attrs.media_position || 0;
                positionUpdatedAt = attrs.media_position_updated_at
                    ? new Date(attrs.media_position_updated_at).getTime()
                    : Date.now();
            }
        }

        // ä¸Šä¸€æ¬¡æ›´æ–°çš„ä½ç½®ï¼Œç”¨äºé˜²æŠ–
        let lastPosition = 0;

        // äºŒåˆ†æŸ¥æ‰¾å½“å‰æ­Œè¯ç´¢å¼•ï¼ˆä¸ ncloud-lyrics-card.js ä¸€è‡´ï¼‰
        function findCurrentLyricIndex(lyrics, currentTime) {
            if (!lyrics.length) return -1;

            // æ·»åŠ  0.3s ç¼“å†²åŒºï¼Œé¿å…æ—¶é—´æˆ³ä¸º 0 çš„æ­Œè¯ç«‹å³é«˜äº®
            const effectiveTime = currentTime - 0.3;
            if (effectiveTime < lyrics[0].time) return -1;
            if (effectiveTime >= lyrics[lyrics.length - 1].time) return lyrics.length - 1;

            let left = 0;
            let right = lyrics.length - 1;

            while (left <= right) {
                const mid = Math.floor((left + right) / 2);
                if (lyrics[mid].time <= effectiveTime) {
                    if (mid + 1 >= lyrics.length || lyrics[mid + 1].time > effectiveTime) {
                        return mid;
                    }
                    left = mid + 1;
                } else {
                    right = mid - 1;
                }
            }
            return left;
        }

        function animationUpdate() {
            if (!positionUpdatedAt) {
                requestAnimationFrame(animationUpdate);
                return;
            }

            // è®¡ç®—å½“å‰æ—¶é—´
            let currentTime = currentPosition;
            if (isPlaying) {
                const elapsed = (Date.now() - positionUpdatedAt) / 1000;
                currentTime = currentPosition + elapsed;
            }

            // æ›´æ–°è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤º
            if (duration > 0) {
                const percent = Math.min((currentTime / duration) * 100, 100);
                document.getElementById('progressFill').style.width = `${percent}%`;
                document.getElementById('currentTime').textContent = formatTime(currentTime);
            }

            // æ­Œè¯åŒæ­¥
            if (mergedLyrics.length > 0) {
                // åº”ç”¨æ­Œè¯åç§»é‡ (æ­£å€¼=æ­Œè¯å»¶å/ç­‰å¾…æ›´ä¹…ï¼Œè´Ÿå€¼=æ­Œè¯æå‰)
                const adjustedTime = currentTime + (lyricOffset / 1000);

                // 0.05 ç§’é˜²æŠ–ï¼Œé¿å…é¢‘ç¹æ›´æ–°
                if (Math.abs(adjustedTime - lastPosition) < 0.05) {
                    requestAnimationFrame(animationUpdate);
                    return;
                }
                lastPosition = adjustedTime;

                // ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾è·å–å½“å‰æ­Œè¯ç´¢å¼•
                const newIndex = findCurrentLyricIndex(mergedLyrics, adjustedTime);

                // æ›´æ–°é«˜äº®çŠ¶æ€
                const lines = document.querySelectorAll('.lyric-line');
                if (newIndex !== currentIndex) {
                    currentIndex = newIndex;
                    lines.forEach((el, i) => el.classList.toggle('active', i === currentIndex));
                }

                // æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®ï¼ˆæ­Œè¯æœªå¼€å§‹æ—¶æ˜¾ç¤ºç¬¬ä¸€å¥ï¼‰
                const targetIndex = currentIndex >= 0 ? currentIndex : 0;
                if (targetIndex < lines.length) {
                    const targetLine = lines[targetIndex];
                    const container = document.getElementById('lyricsScroll');
                    const containerHeight = document.querySelector('.lyrics-container').offsetHeight;
                    const offset = targetLine.offsetTop - containerHeight / 2 + targetLine.offsetHeight / 2;
                    container.style.transform = `translateY(-${Math.max(0, offset)}px)`;
                }
            }

            requestAnimationFrame(animationUpdate);
        }

        // ========== è¾…åŠ©å‡½æ•° ==========
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function showStatus(type, message) {
            const icons = { loading: 'ğŸµ', error: 'âŒ', info: 'â„¹ï¸', config: 'âš™ï¸' };
            document.getElementById('statusMessage').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
            document.querySelector('.status-message .icon').textContent = icons[type] || 'ğŸµ';
            document.getElementById('statusText').innerHTML = message;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // è‡ªåŠ¨éšè— UI æ§ä»¶ï¼ˆ3ç§’æ— æ“ä½œåéšè—ï¼‰
        let hideControlsTimer = null;
        function showControls() {
            document.body.classList.add('show-controls');
            clearTimeout(hideControlsTimer);
            hideControlsTimer = setTimeout(() => {
                document.body.classList.remove('show-controls');
            }, 3000);
        }
        document.addEventListener('mousemove', showControls);
        document.addEventListener('click', showControls);
        // ç§»åŠ¨ç«¯è§†å›¾åˆ‡æ¢
        function toggleMobileView() {
            document.body.classList.toggle('mobile-lyrics-view');
            const btn = document.getElementById('lyricsToggleBtn');
            const isLyricsView = document.body.classList.contains('mobile-lyrics-view');
            btn.textContent = isLyricsView ? 'ğŸ¹' : 'ğŸµ';
            btn.title = isLyricsView ? 'åˆ‡æ¢æ’­æ”¾å™¨' : 'åˆ‡æ¢æ­Œè¯';
        }

        // åˆå§‹æ˜¾ç¤ºä¸€æ¬¡
        showControls();

        // è¿›åº¦æ¡ç‚¹å‡»è·³è½¬
        document.getElementById('progressBar').addEventListener('click', (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            const seekPosition = duration * percent;
            seekTo(seekPosition);
            // ç«‹å³æ›´æ–° UI åé¦ˆ
            currentPosition = seekPosition;
            positionUpdatedAt = Date.now();
            window._lastSeekTime = Date.now(); // é˜²æ­¢ HA çš„æ—§æ•°æ®è¦†ç›–
        });

        // ========== å¯åŠ¨ ==========
        async function init() {
            // æ£€æŸ¥æ˜¯å¦æœ‰é…ç½®
            if (!config || !config.entity || !config.token) {
                showStatus('config', 'é¦–æ¬¡ä½¿ç”¨è¯·é…ç½®æ’­æ”¾å™¨');
                showConfig();
                return;
            }

            showStatus('loading', 'æ­£åœ¨è¿æ¥...');

            const state = await fetchState();
            if (state) {
                update(state);

                // æ›´æ–°é¡¶éƒ¨æ˜¾ç¤ºçš„æ’­æ”¾å™¨åç§°
                const playerName = state.attributes?.friendly_name || ENTITY_ID.replace('media_player.', '');
                document.getElementById('currentPlayerName').textContent = playerName;

                // å¯åŠ¨å®šæ—¶åˆ·æ–°
                refreshInterval = setInterval(async () => {
                    const s = await fetchState();
                    if (s) update(s);
                }, 1000);
                // å¯åŠ¨åŠ¨ç”»å¸§
                requestAnimationFrame(animationUpdate);
            }
        }

        init();
    </script>
</body>

</html>